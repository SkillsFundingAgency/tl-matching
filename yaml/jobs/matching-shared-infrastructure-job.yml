parameters:
- name: baseName
  type: string
- name: serviceConnection
  type: string
- name: sharedEnvironmentId
  type: string
jobs:
- job: DeploySharedInfrastructure_${{parameters.sharedEnvironmentId}}
  steps:
  - checkout: self

  - template: ./Infrastructure/steps/deploy-template.yml@devopsTemplates
    parameters:
      serviceConnection: ${{ parameters.serviceConnection }}
      subscriptionId: $(subscriptionId)
      resourceGroupName: $(SharedResourceGroup)
      location: 'West Europe'
      templateFilePath: './azure/matching-shared.json'
      armParameterOverrideString: '-environmentNameAbbreviation "${{parameters.baseName}}" 
        -sqlServerAdminUsername "$(SQLServerAdminUsername)" 
        -sqlServerAdminPassword "$(SQLServerAdminPassword)" 
        -sqlServerActiveDirectoryAdminLogin "$(SQLServerActiveDirectoryAdminLogin)" 
        -sqlServerActiveDirectoryAdminObjectId "$(SQLServerActiveDirectoryAdminObjectId)" 
        -threatDetectionEmailAddress "$(ThreatDetectionEmailAddress)" 
        -appServicePlanTier "$(AppServicePlanTier)" 
        -appServicePlanSize "$(AppServicePlanSize)" 
        -appServicePlanInstances "$(AppServicePlanInstances)" 
        -azureWebsitesRPObjectId "$(AzureWebsitesRPObjectId)" 
        -keyVaultReadWriteObjectIds "$(KeyVaultReadWriteObjectIds)"
        -keyVaultFullAccessObjectIds "$(keyVaultFullAccessObjectIds)"'
      processOutputs: true
  - pwsh: Write-Host "##vso[task.setvariable variable=SharedResourceGroup;isOutput=true]$(SharedResourceGroup)"
    name: SharedVariables