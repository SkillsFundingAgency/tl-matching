parameters:
  - name: serviceConnection
    type: string
  - name: tableName
    type: string
    default: 'configuration'
jobs:
- job: PublishSite
  pool:
    name: 'Azure Pipelines'
    vmImage: 'vs2017-win2016'
  # dependsOn: 
  #   - DeployMatchingInfrastructure 
  steps:   
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'appdrop'
        downloadPath: '$(System.ArtifactsDirectory)'
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'sqldrop'
        downloadPath: '$(System.ArtifactsDirectory)'
  
    - pwsh: |
        Get-ChildItem -Recurse
      displayName: Show Files
      workingDirectory: $(System.ArtifactsDirectory)
    

    - task: GenerateEnvironmentConfiguration@3
      displayName: 'Process schemas in $(System.ArtifactsDirectory)/appdrop/config'
      inputs:
        SourcePath: '$(System.ArtifactsDirectory)/appdrop/config'
        ServiceConnectionName: ${{ parameters.serviceConnection}}
        StorageAccountName: '$(ConfigStorageAccountName)'
        TableName: Configuration

    # - task: GenerateEnvironmentConfiguration@3
    #   inputs:
    #     SourcePath: '$(System.DefaultWorkingDirectory)'
    #     TargetFilename: '*.schema.json'
    #     ServiceConnectionName: ${{ parameters.serviceConnection }}
    #     StorageAccountName: ${{ parameters.configStorageAccountName }}
    #     TableName: ${{ parameters.tableName }}

    #Your build pipeline references an undefined variable named ‘SharedSQLServerName’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
    #Your build pipeline references an undefined variable named ‘SQLDatabaseName’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
    #Your build pipeline references an undefined variable named ‘SQLServerAdminUsername’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
    #Your build pipeline references an undefined variable named ‘SQLServerAdminPassword’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
    # - task: SqlAzureDacpacDeployment@1
    #   displayName: 'Azure SQL Publish'
    #   inputs:
    #     azureSubscription: 'SFA-TL-Dev/Test'
    #     ServerName: '$(SharedSQLServerName).database.windows.net'
    #     DatabaseName: '$(SQLDatabaseName)'
    #     SqlUsername: '$(SQLServerAdminUsername)'
    #     SqlPassword: '$(SQLServerAdminPassword)'
    #     DacpacFile: '$(System.DefaultWorkingDirectory)/tl-matching/drop/src/Sfa.Tl.Matching.Database/bin/Release/Sfa.Tl.Matching.Database.dacpac'
    #     AdditionalArguments: '/p:GenerateSmartDefaults=True'